<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Parking Gent</title>
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <style>
    :root { --pad: 14px; --radius: 14px; }
    html, body { margin:0; padding:0; background: var(--bg); color: var(--fg);
      font-family: -apple-system, system-ui, 'SF Pro Text', Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    @media (prefers-color-scheme: light) {
      :root { --bg: #ffffff; --card: #f7f7f8; --fg:#111; --muted:#666; --accent:#0a84ff; --ok:#2ecc71; --warn:#e67e22; --bad:#ff3b30; }
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg: #0b0b0c; --card: #151517; --fg:#f8f8f8; --muted:#aaa; --accent:#0a84ff; --ok:#3ddc97; --warn:#f39c12; --bad:#ff453a; }
    }
    header { position: sticky; top: env(safe-area-inset-top); backdrop-filter: saturate(180%) blur(12px);
      background: color-mix(in oklab, var(--bg) 80%, transparent);
      display:flex; gap:10px; align-items:center; padding: calc(env(safe-area-inset-top) + 8px) var(--pad) 8px var(--pad); border-bottom: 1px solid color-mix(in oklab, var(--fg) 15%, transparent); }
    header h1 { font-size: 18px; margin: 0; font-weight: 700; letter-spacing: 0.2px; }
    header .group { display:flex; gap:8px; align-items:center; width:100%; }
    header button, header input { border:1px solid color-mix(in oklab, var(--fg) 15%, transparent); background: var(--card); color: var(--fg); border-radius: 999px; padding:8px 12px; }
    header input { flex:1; outline:none; }
    header button { font-weight: 600; white-space: nowrap; }
    #list { padding: 8px; display: grid; grid-template-columns: 1fr; gap: 10px; }
    .card { border-radius: var(--radius); background: var(--card); padding: 12px; border:1px solid color-mix(in oklab, var(--fg) 12%, transparent); }
    .row { display:flex; justify-content: space-between; align-items: baseline; gap: 10px; }
    .name { font-weight: 700; font-size: 16px; }
    .meta { color: var(--muted); font-size: 12px; }
    .chip { padding: 2px 8px; border-radius: 999px; font-size: 12px; border:1px solid color-mix(in oklab, var(--fg) 20%, transparent); text-transform: capitalize; }
    .chip.open { background: color-mix(in oklab, var(--ok) 15%, transparent); }
    .chip.closed { background: color-mix(in oklab, var(--bad) 15%, transparent); }
    .bar { height: 7px; border-radius: 999px; background: color-mix(in oklab, var(--fg) 10%, transparent); overflow: hidden; margin-top: 8px; }
    .fill { height: 100%; background: var(--accent); width: 0%; }
    .row2 { display:flex; gap:14px; align-items:center; margin-top:6px; flex-wrap: wrap; }
    .pill { font-size: 12px; color: var(--muted); }
    .pill strong { color: var(--fg); }
    .actions { display:flex; gap:10px; margin-top:10px; flex-wrap: wrap; }
    .btn { appearance:none; border: 1px solid color-mix(in oklab, var(--fg) 20%, transparent); background: transparent; color: var(--fg);
      border-radius: 10px; padding: 8px 12px; font-weight:600; text-decoration: none; display: inline-block; }
    .fav { border:1px solid color-mix(in oklab, var(--fg) 25%, transparent); border-radius: 10px; padding: 6px 10px; font-weight:700; }
    .fav.on { background: color-mix(in oklab, var(--accent) 20%, transparent); }
    footer { text-align:center; color: var(--muted); font-size: 12px; padding: 24px 12px 40px; }
    .hidden { display:none; }
  </style>
  <script>
    const API_URL = "https://gent.opendatasoft.com/api/records/1.0/search/?dataset=bezetting-parkeergarages-real-time&rows=200";
    const LOC_URL = "https://gent.opendatasoft.com/api/records/1.0/search/?dataset=locaties-openbare-parkings-gent&rows=200";

    // Pinned & aliases
    const PINNED_LABELS = ["Interparking Zuid", "Parking Reep"]; // canonical labels shown first
    const PINNED_MATCH = [
      "interparking zuid", "zuid", "p3 zuid", "parking zuid",
      "reep", "parking reep"
    ];
    const ALIASES = {
      "zuid": "Interparking Zuid",
      "gent zuid": "Interparking Zuid",
      "interparking zuid": "Interparking Zuid",
      "p3 zuid": "Interparking Zuid",
      "parking zuid": "Interparking Zuid",
      "reep": "Parking Reep",
      "parking reep": "Parking Reep"
    };

    let DATA = [];
    let LOCS = {};
    let SHOW_MODE = 'all'; // 'all' | 'favs'; first load shows all
    const LS_KEY = 'parkinggent.favorites';

    function normalizeName(n) {
      if (!n) return "";
      return n.toLowerCase()
        .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9\s]/g,' ')
        .replace(/\s+/g,' ')
        .trim();
    }
    async function fetchJSON(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Netwerkfout " + res.status);
      return await res.json();
    }
    function formatTime(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      const now = new Date();
      const diff = Math.round((now - d)/1000);
      if (diff < 60) return diff + "s";
      const m = Math.floor(diff/60);
      if (m < 60) return m + " min";
      const h = Math.floor(m/60);
      return h + " u";
    }
    function pct(avail, total) {
      if (!total || total <= 0) return 0;
      const used = total - avail;
      return Math.max(0, Math.min(100, Math.round(100 * used / total)));
    }

    function mergeRecords(bezetting, locaties) {
      // Build locations map
      const map = {};
      (locaties.records||[]).forEach(r => {
        const f = r.fields || {};
        const nameRaw = f.naam || f.name || f.title;
        const key = normalizeName(nameRaw || "");
        const canon = ALIASES[key] || (nameRaw || "Onbekend");
        map[key] = {
          canon,
          lat: (r.geometry && r.geometry.coordinates && r.geometry.coordinates[1]) || f.lat || f.latitude,
          lon: (r.geometry && r.geometry.coordinates && r.geometry.coordinates[0]) || f.lon || f.longitude,
          capacity: f.capaciteit || f.capacity || f.plaatsen || null,
          address: f.adres || f.address || null
        };
      });
      LOCS = map;

      const out = (bezetting.records||[]).map(r => {
        const f = r.fields || {};
        const nameRaw = f.parking_name || f.name || f.title || f.naam || f.description || "Onbekend";
        const key = normalizeName(nameRaw);
        const aliasCanon = ALIASES[key] || nameRaw;
        const keyAlias = normalizeName(aliasCanon);
        // Try to find location
        const loc = map[keyAlias] || map[key] ||
          Object.entries(map).find(([k]) => k.includes(keyAlias) || keyAlias.includes(k))?.[1] || {};
        const avail = f.availablecapacity ?? f.available_capacity ?? f.freecapacity ?? null;
        const total = f.totalcapacity ?? f.total_capacity ?? loc.capacity ?? null;
        const statusVal = (f.open ?? f.status ?? f.state ?? "").toString().toLowerCase();
        const open = statusVal.includes("open") || statusVal === "true" || statusVal === "1";
        const updated = f.lastupdate || f.last_updated || f.timestamp || r.record_timestamp;
        return {
          name: aliasCanon,
          avail, total,
          status: open ? "open" : (statusVal.includes("closed") ? "closed" : (statusVal || "")),
          updated,
          lat: loc.lat, lon: loc.lon, address: loc.address
        };
      });

      // Ensure pinned entries exist even if realtime didn't return them
      PINNED_LABELS.forEach(label => {
        const k = normalizeName(label);
        const exists = out.some(d => normalizeName(d.name) == k);
        if (!exists) {
          const loc = map[k] || Object.entries(map).find(([kk]) => kk.includes(k))?.[1] || {};
          out.push({
            name: label,
            avail: null,
            total: loc.capacity ?? null,
            status: "",
            updated: null,
            lat: loc.lat, lon: loc.lon, address: loc.address
          });
        }
      });

      return out;
    }

    function isPinnedName(n) {
      const nn = normalizeName(n);
      return PINNED_MATCH.some(p => nn.includes(normalizeName(p)));
    }

    function getFavorites() {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; }
    }
    function setFavorites(arr) {
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }
    function toggleFavorite(name) {
      const norm = normalizeName(name);
      const favs = getFavorites();
      const has = favs.includes(norm);
      const next = has ? favs.filter(x => x !== norm) : [...new Set([...favs, norm])];
      setFavorites(next);
      searchAndFilter(); // re-render
    }
    function isFavorite(name) {
      return getFavorites().includes(normalizeName(name));
    }

    function render(list) {
      const root = document.getElementById("list");
      root.innerHTML = "";
      list.forEach(it => {
        const percentage = pct(Number(it.avail ?? 0), Number(it.total ?? 0));
        const nn = normalizeName(it.name);
        const isZuid = (nn === 'interparking zuid' || nn === 'zuid');
        const favOn = isFavorite(it.name);
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="row">
            <div class="name">${it.name}</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="fav ${favOn ? 'on' : ''}" data-action="fav">${favOn ? '★' : '☆'} Favoriet</button>
              <div class="chip ${it.status==='open'?'open':(it.status==='closed'?'closed':'')}">${it.status || '—'}</div>
            </div>
          </div>
          <div class="bar"><div class="fill" style="width:${percentage}%;"></div></div>
          <div class="row2">
            <div class="pill"><strong>${it.total ?? '—'}</strong> plaatsen</div>
            <div class="pill"><strong>${it.avail ?? '—'}</strong> vrij</div>
            <div class="pill">update ${formatTime(it.updated)} geleden</div>
          </div>
          <div class="actions">
            <button class="btn" data-action="maps">Open in Kaarten</button>
            <button class="btn" data-action="copy">Kopieer naam</button>
            ${isZuid ? '<a class="btn" href="https://www.parkings.gent/parking/interparking-zuid" target="_blank" rel="noopener noreferrer">Officiële pagina</a>' : ''}
          </div>
        `;
        card.querySelector('[data-action="maps"]').addEventListener('click', () => {
          if (it.lat && it.lon) {
            const url = `http://maps.apple.com/?ll=${it.lat},${it.lon}&q=${encodeURIComponent(it.name)}`;
            window.location.href = url;
          } else {
            const url = `http://maps.apple.com/?q=${encodeURIComponent('Parking ' + it.name + ' Gent')}`;
            window.location.href = url;
          }
        });
        card.querySelector('[data-action="copy"]').addEventListener('click', async () => {
          try { await navigator.clipboard.writeText(it.name); alert("Gekopieerd!"); } catch(e){}
        });
        card.querySelector('[data-action="fav"]').addEventListener('click', () => toggleFavorite(it.name));
        root.appendChild(card);
      });
      document.getElementById("count").textContent = list.length;
    }

    function passesOpenFilter(item) {
      const nn = normalizeName(item.name);
      // pinned always pass
      if (isPinnedName(item.name)) return true;
      // explicit open
      if (item.status === 'open' || item.status === true || item.status === 1) return true;
      // unknown but has numeric avail -> allow
      if ((!item.status || item.status === '') && (item.avail !== null && item.avail !== undefined)) return true;
      return false;
    }

    function searchAndFilter() {
      const q = normalizeName(document.getElementById("q").value);
      const onlyOpen = document.getElementById("onlyOpen").checked;
      let arr = DATA.filter(it => (!q || normalizeName(it.name).includes(q)) && (!onlyOpen || passesOpenFilter(it)));

      if (SHOW_MODE === 'favs') {
        const favs = new Set(getFavorites());
        arr = arr.filter(it => favs.has(normalizeName(it.name)));
      }

      // Sort: Reep/Zuid pinned first, then by availability desc, then by name
      arr.sort((a,b)=>{
        const ap = isPinnedName(a.name) ? 1 : 0;
        const bp = isPinnedName(b.name) ? 1 : 0;
        if (ap !== bp) return bp - ap;
        return ((b.avail??-1) - (a.avail??-1)) || a.name.localeCompare(b.name);
      });

      render(arr);
      updateModeButton();
    }

    async function refresh() {
      try {
        document.getElementById("state").textContent = "Bezig met verversen…";
        const [bez, loc] = await Promise.all([fetchJSON(API_URL), fetchJSON(LOC_URL)]);
        DATA = mergeRecords(bez, loc);
        searchAndFilter();
        document.getElementById("state").textContent = "Live";
        document.getElementById("last").textContent = new Date().toLocaleTimeString();
      } catch (e) {
        document.getElementById("state").textContent = "Fout";
        console.error(e);
      }
    }

    function updateModeButton() {
      const btn = document.getElementById("toggleMode");
      btn.textContent = (SHOW_MODE === 'favs') ? "Toon alle parkings" : "Toon favorieten";
    }

    window.addEventListener('load', async () => {
      if ('serviceWorker' in navigator) {
        try { navigator.serviceWorker.register('./sw.js'); } catch(e){}
      }
      document.getElementById("q").addEventListener('input', searchAndFilter);
      document.getElementById("onlyOpen").addEventListener('change', searchAndFilter);
      document.getElementById("btnRefresh").addEventListener('click', refresh);
      document.getElementById("toggleMode").addEventListener('click', ()=>{
        SHOW_MODE = (SHOW_MODE === 'favs') ? 'all' : 'favs';
        searchAndFilter();
      });
      updateModeButton();
      await refresh();
      setInterval(refresh, 60000);
    });
  </script>
</head>
<body>
  <header>
    <h1>Parking Gent</h1>
    <div class="group">
      <input id="q" placeholder="Zoek…" inputmode="search" autocomplete="off" />
      <label class="meta" title="Toon enkel parkings met status 'open'. Reep & Zuid blijven zichtbaar."><input type="checkbox" id="onlyOpen" /> Open</label>
      <button id="btnRefresh">Ververs</button>
      <button id="toggleMode">Toon favorieten</button>
    </div>
  </header>
  <div id="list" role="list"></div>
  <footer>
    <div class="meta">Status: <strong id="state">—</strong> • Laatste verversing: <span id="last">—</span> • <span id="count">0</span> items</div>
    <div class="meta">Tip: klik op ★ Favoriet om parkings aan je favorieten toe te voegen en wissel dan met “Toon favorieten”.</div>
    <div class="meta">Bron: Stad Gent Open Data (realtime + locaties)</div>
  </footer>
</body>
</html>
